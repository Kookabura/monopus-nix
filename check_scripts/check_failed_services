#!/bin/bash

SERVICES=${*}
state=3
failed=""
states_text=("ok" "warning" "critical" "unknown")

if [ -f /bin/systemctl ]; then

	failed=$(/bin/systemctl --failed --no-legend)
	failed=${failed/ */}  # Strip everything after first space

	if [ "$failed" == "‚óè" ]; then
		failed=$(/bin/systemctl --failed --no-legend | sed '/^[[:space:]]*$/d' | awk '{print $2}')
	fi

	failed=${failed/.service/} # Strip .service suffix
	
	if [ "$failed" != "" ]; then

		state=1
		
		if [ "$SERVICES" != "" ]; then
		
			for SERVICE in $SERVICES
			do
				
				if [ ${failed[@]} == "${SERVICE}" ]; then
					state=2
				fi
				
			done
		
		fi
	
	else
		state=0
	fi
fi

echo "check_failed_services.${states_text[$state]}::services==$failed | services=${#failed[@]};;;"
exit $state
